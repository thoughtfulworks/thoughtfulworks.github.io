<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo/logo_square.png">

<title>Partitions and Bucketing in Spark | thoughtful works</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Partitions and Bucketing in Spark | thoughtful works</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Partitions and Bucketing in Spark" />
<meta name="author" content="senthil" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Partitioning and bucketing are used to improve the reading of data by reducing the cost of shuffles, the need for serialization, and the amount of network traffic." />
<meta property="og:description" content="Partitioning and bucketing are used to improve the reading of data by reducing the cost of shuffles, the need for serialization, and the amount of network traffic." />
<link rel="canonical" href="http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" />
<meta property="og:url" content="http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" />
<meta property="og:site_name" content="thoughtful works" />
<meta property="og:image" content="http://localhost:4000/assets/images/posts-cover-images/spark-bucketing-and-partitions.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-25T00:00:00+05:30" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/posts-cover-images/spark-bucketing-and-partitions.jpg" />
<meta property="twitter:title" content="Partitions and Bucketing in Spark" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"senthil"},"dateModified":"2022-07-25T00:00:00+05:30","datePublished":"2022-07-25T00:00:00+05:30","description":"Partitioning and bucketing are used to improve the reading of data by reducing the cost of shuffles, the need for serialization, and the amount of network traffic.","headline":"Partitions and Bucketing in Spark","image":"http://localhost:4000/assets/images/posts-cover-images/spark-bucketing-and-partitions.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo/logo_transparent.png"},"name":"senthil"},"url":"http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions"}</script>
<!-- End Jekyll SEO tag -->

    
<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

<script src="https://kit.fontawesome.com/a04651ccb8.js" crossorigin="anonymous"></script>

</head>




<body class="line-numbers">
    <div class="site-wrapper">
        <header class="site-header">
            <div class="outer site-nav-main">
                <div class="inner">
                    <nav class="site-nav">
                        <div class="site-nav-left-wrapper">
                            <div class="site-nav-left">
                                <!-- Site Logo/Name -->
                                <a class="navbar-brand" href="/">
                                    <img src="/assets/images/logo/logo_transparent.png" alt="thoughtful works">
                                </a>
                                &nbsp;&nbsp;
                                <a href="https://twitter.com/thoughtfulwx" target="_blank" style="text-decoration: none;">
                                    <span style="color:#000000; font-size: 25px;">
                                        <i class="fa-brands fa-x-twitter"></i>
                                    </span>
                                </a>
                                <a href="https://www.instagram.com/thoughtful.works/" target="_blank" style="text-decoration: none;">
                                    <span style="color:#000000; font-size: 25px;">
                                        <i class="fa-brands fa-square-instagram"></i>
                                    </span>
                                </a> 
                                <a href="https://github.com/thoughtfulworks?tab=repositories" target="_blank" style="text-decoration: none;">
                                    <span style="color:#000000; font-size: 25px;">
                                        <i class="fa-brands fa-github"></i>
                                    </span>
                                </a>
                                <span style="color: grey; font-size: 25px;"><i class="fa-solid fa-ellipsis-vertical"></i></span>
                                <script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </header>
    </div>

	<!-- Defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>

    <!-- Back to top icon/button -->
    <script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
    <!-- <script>addBackToTop()</script>     -->
    <script>addBackToTop({
        diameter: 50,
        backgroundColor: 'rgba(22, 22, 23, .8)',
        textColor: '#fff'
        })
    </script>

    <!-- Begin Sidebar Navigation -->
    <div class="sidebar">    
    </div>   
    <div class="nav-icon">
        <div class="hamburger-bar"></div>
    </div>
    <div id="blackover-nav" class="blackover"></div>
    <nav id="menu">
        <ul>
            <h4>Navigation</h4>
            <li><a href="/tags">Tags</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/authors">Contributors</a></li>
            <li><a href="/contact">Contact us</a></li>       
        </ul>   
    </nav>

    <!-- <script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script> -->
    <!-- End Sidebar Navigation -->

    <div class="site-content ">

    <div class="container">
        <!-- Content -->
        <div class="main-content">
            <div class="entry-header">
    <!-- Kicker -->
    
        <!--<h6 class="kicker">Apache Spark</h6>-->
        <span class="kicker">
            <a href="/categories#apache-spark">Apache Spark</a>
        </span>
    

    <!-- Post Title -->
    <h1 class="posttitle">Partitions and Bucketing in Spark</h1>

    <!-- Author and Date -->
    
    
        <div class="d-flex align-items-center mt-4" style="font-size: 100%">
            <div>
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/6fc127cda8cd99830932538a58dc6173?s=250&d=mm&r=x" alt="Senthil Nayagan">
                
            </div>            
            <div>
                
                    <!-- <a target="_blank" href="https://www.linkedin.com/in/senthilnayagan" style="color: black; border-bottom: 1px solid blue;"><b>Senthil Nayagan</b></a> -->
                    <span class="author-name">
                        <a target="_blank" href="https://www.linkedin.com/in/senthilnayagan">Senthil Nayagan</a>
                    </span>
                
                
                    &nbsp;&nbsp;&nbsp;&nbsp;
                    <span class="social-connect-icon">
                        <a target="_blank" href="https://senthilnayagan.com/">
                            <i class="fa-solid fa-window-maximize"></i>
                        </a>
                    </span> 
                                     
                
                    &nbsp;
                    <span class="social-connect-icon">
                        <a target="_blank" href="https://fosstodon.org/@towardsdata">
                            <i class="fa-brands fa-mastodon"></i>
                        </a>                         
                    </span>
                                
                
                    &nbsp;
                    <span class="social-connect-icon">
                        <a target="_blank" href="https://twitter.com/SenthilNayagan">
                            <i class="fa-brands fa-x-twitter"></i>
                        </a>                         
                    </span>                    
                
                
                    &nbsp;
                    <span class="social-connect-icon">
                        <a target="_blank" href="https://www.instagram.com/senthilnayagan">
                            <i class="fa-brands fa-square-instagram"></i>
                        </a>                         
                    </span>                    
                                                   
                <br/> 
                <span class="post-date-and-mins-read">           
                    
                        <i class="fa-regular fa-calendar-days"></i>&nbsp;<time datetime="2022-07-25T00:00:00+05:30">Jul 25, 2022</time>
                    
                    
                    -&nbsp;<i class="fa-solid fa-clock"></i>&nbsp;13 Mins Read
                </span>
            </div>            
        </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->
<!---->

<!-- Tags -->
<div class="article-post">
    <ul class="tags">
        
        
        <li>
            <a class="smoothscroll" href="/tags#apache-spark">apache-spark</a>
        </li>
        
        <li>
            <a class="smoothscroll" href="/tags#bucketing">bucketing</a>
        </li>
        
        <li>
            <a class="smoothscroll" href="/tags#partition">partition</a>
        </li>
        
    </ul>
</div>

<!-- Summary -->
<div class="summary">
    
    <hr class="grey_line"></hr>
</div>

<!-- Draft - Shows writing in progress -->
<div class="draft">
    
        <div class="row" style="padding: 0; margin: 0;">
            <div class="col-md-1" style="padding: 5px; margin: 0;">
                <span class="icon">
                    <img src="/assets/images/icons/work-in-progress.png" alt="Work in progress">
                </span>
            </div>
            <div class="col-md-11 align-self-center" style="padding: 5px; margin: 0;">
                <span>
                    If you have any suggestions for improving the content or notice any inaccuracies, please email us at <a href="mailto:hello@rustinaction.dev">hello@rustinaction.dev</a>. Thanks!
                </span>
            </div>
        </div>
    
</div>

<!-- Featured Image -->

<div class="entry-featured-image">
    
        <img class="featured-image " src="/assets/images/posts-cover-images/spark-bucketing-and-partitions.jpg" alt="Partitions and Bucketing in Spark">
    
    
 </div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!---->
    <div class="toc mt-4 mb-4 lead" style="font-size: 85%">
        <h5 class="font-weight-bold">Table of contents</h5>
        <ul>
  <li><a href="#partitioning-in-spark">Partitioning in Spark</a>
    <ul>
      <li><a href="#parallelism">Parallelism</a></li>
      <li><a href="#co-location">Co-location</a></li>
      <li><a href="#types-of-partitioning">Types of partitioning</a>
        <ul>
          <li><a href="#input-partition">Input partition</a>
            <ul>
              <li><a href="#what-influences-the-input-partition">What influences the input partition?</a></li>
            </ul>
          </li>
          <li><a href="#output-partition">Output partition</a>
            <ul>
              <li><a href="#what-influences-the-output-partition">What influences the output partition?</a></li>
            </ul>
          </li>
          <li><a href="#shuffle-partition">Shuffle partition</a>
            <ul>
              <li><a href="#how-to-set-shuffle-partition">How to set shuffle partition?</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#spark-partitioning-strategies">Spark partitioning strategies</a></li>
      <li><a href="#how-do-we-get-the-right-partitions">How do we get the right partitions?</a>
        <ul>
          <li><a href="#recommended-number-of-partitions">Recommended number of partitions</a></li>
          <li><a href="#recommended-partition-size">Recommended partition size</a></li>
          <li><a href="#other-factors-to-be-considered">Other factors to be considered</a></li>
        </ul>
      </li>
      <li><a href="#hive-partition-vs-spark-partition">Hive partition vs. Spark partition</a></li>
    </ul>
  </li>
  <li><a href="#bucketing-in-spark">Bucketing in Spark</a>
    <ul>
      <li><a href="#sorting-the-bucket">Sorting the bucket</a></li>
      <li><a href="#configure-bucketing">Configure bucketing</a></li>
      <li><a href="#how-to-create-buckets">How to create buckets?</a></li>
      <li><a href="#bucketing-applicable-only-to-persistent-tables">Bucketing applicable only to persistent tables</a></li>
    </ul>
  </li>
</ul>
    </div>
    
    <!-- End Toc -->
    <p>Partitioning and bucketing are used to improve the reading of data by reducing the cost of shuffles, the need for serialization, and the amount of network traffic.</p>

<h1 id="partitioning-in-spark">Partitioning in Spark</h1>

<p>Apache Spark’s <strong>speed</strong> in processing huge amounts of data is one of its primary selling points. Spark’s speed comes from its ability to allow developers to run multiple tasks <em>in parallel</em> and <em>independently</em> across hundreds of machines in a cluster or across multiple cores on a desktop. It’s all possible because Apache Spark <strong>RDDs</strong> serve as the <em>main interface</em>. These RDDs are <em>partitioned</em> and run in parallel behind the scenes.</p>

<p>So, what exactly is the partition in Spark? Spark organizes data into smaller pieces called “partitions”,  each of which is kept on a separate node in the cluster. Each partition is an atomic chunk of data. We can think of partition as a subset of our data. Simply said, it’s a subset of the superset.</p>

<h2 id="parallelism">Parallelism</h2>

<p>Partitions are the fundamental building blocks of parallelism in Apache Spark. Spark’s parallelism enables developers to parallelly execute several tasks across a large number of nodes in a cluster.</p>

<h2 id="co-location">Co-location</h2>

<p>Partitioning can also deliver a significant speed benefit by reducing the amount of data to be shuffled across the network. If RDDs are too large to fit on a single node, they must be partitioned (distributed) across many nodes. Apache Spark <em>automatically</em> partitions RDDs and distributes them across different nodes.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="/assets/images/posts/apache-spark-data-partitions.png" alt="Data Partitioned by Spark" /></th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><sup><em>Figure 1: Data Partitioned by Spark.</em></sup></td>
      <td><br /><br /></td>
    </tr>
  </tbody>
</table>

<p>Spark is a distributed computing system, so it can operate on data partitons in parallel. A transformation or any sort of computation on a data partitons is called a <strong>task</strong> and each task generally takes place on one core. As there is one task for every partition, the total number of tasks is the same as the total number of partitions. Optimal partitioning in Spark strikes a balance between read performance and write performance.</p>

<p>Please take the following considerations into account:</p>

<ul>
  <li><strong>Too many partitions:</strong> Too many partitions can slow down the time it takes to read and force Spark to create more tasks to process the data, which could cause the driver to get an “out of memory” error.</li>
  <li><strong>Too many small partitions</strong> could waste a lot of time because the cluster would spend more time coordinating tasks and sending data between workers than actually doing the job.</li>
  <li><strong>Overly large partitions</strong> can even cause executor “out of memory” errors.</li>
  <li>Using a <strong>small number of large partitions</strong> may leave some worker cores idle. If one of the workers is falling behind the other, we may have to wait a long time for the last task to be completed. If a worker goes down, we’ll have to reprocess a huge amount of data.</li>
  <li><strong>Few or lack of partitions:</strong> On the other hand, a lack of or few partitions may indicate that Spark’s parallelism is not being fully utilized, resulting in long computation and write times. Furthermore, having few partitions may result in skewed data and inefficient resource use.</li>
  <li><strong>Data skewness:</strong> We refer to data as “skewed” when it is not evenly distributed among workers. In Apache Spark, transformations like <code>join</code>, <code>groupBy</code>, and <code>orderBy</code> change data partitioning, which results in data skewness. Common effects of skewed data include the following:
    <ul>
      <li><strong>Slow running stages or tasks:</strong> Certain operations will take very long to complete because of the huge volume of data that a particular worker must process.</li>
      <li><strong>Spilling data to disk:</strong> In the event that more data is not able to fit in the memory of a worker, it must be written to disk.</li>
      <li><strong>Out-of-memory error:</strong> If worker runs out of disk space, an error is thrown.</li>
    </ul>
  </li>
</ul>

<p>Spark generally does a good job splitting data into partitons to ensure parallelism and efficient computing. However, when dealing with very large data sets, it is sometimes necessary to manually adjust partitions to ensure optimal performance. As a rule of thumb, 128 megabytes is a good size for a data partition when dealing with data sets above 1 gigabyte. That is, <strong># Partitions = Dataset Size (mb) / 128 mb</strong>.</p>

<p>To get us started with partitioning, here are some fundamentals:</p>

<ul>
  <li>Every node (worker) in a Spark cluster contains one or more partitions of any size.</li>
  <li>By default, Spark tries to set the number of partitions automatically based on the total number of cores on all the executor nodes. This is the most effective method for determining the total number of spark partitions in an RDD. However, we can manually set it by passing it as a second parameter to <code>parallelize</code> (for example, <code>sc.parallelize(data, 10)</code>). </li>
  <li>The number of partitions in Spark is configurable.</li>
  <li>Only one partition is processed by one executor at a time, so the size and number of partitions handed to the executor are directly proportional to the time it takes to complete them.</li>
</ul>

<h2 id="types-of-partitioning">Types of partitioning</h2>

<p>We bring in the data, transform it, and then either write it somewhere else or display it on our console or screen. This allows us to further divide Spark partitions into three categories. </p>

<ul>
  <li><strong>Input partition</strong> - Control the size of the partition using <code>spark.sql.files.maxPartitionBytes</code></li>
  <li><strong>Output partition</strong> - Control the size of the partition using <code>coalesce</code> (to reduce partition) and <code>repartition</code> (to reduce or increase partition)</li>
  <li><strong>Shuffle partition</strong> - Control the partition count using <code>spark.sql.shuffle.partitions</code></li>
</ul>

<h3 id="input-partition">Input partition</h3>

<p>When a job is submitted for processing, each data partition is sent to the specific executors. Each executor processes one partition at a time. Hence, the time it takes each executor to process data is directly proportional to the size and number of partitions. The more partitions there are, the more work will be distributed (shuffled) among the executors. There will also be fewer partitions. This means that processing will be done faster and in larger chunks.</p>

<h4 id="what-influences-the-input-partition">What influences the input partition?</h4>

<p>Since the input partition is a critical parameter for performance, how should we control the size of the partition? Spark has a property called <code>spark.sql.files.maxPartitionBytes</code> that can be used to control the number of bytes that are packed into a single partition when reading files, and if we want to check the number of partitions, we can do it by using the method <code>rdd.getNumPartitions()</code>. The another alternative method to get the number of partitions is <code>rdd.partitions.size()</code>.</p>

<blockquote>
  <p><strong>Note:</strong> The default value for <code>spark.sql.files.maxPartitionBytes</code> property is 134217728 (128 MB). In the event that the size of either the input file block or a single partition is more than 128 MB, Spark will split the read into multiple partitions. This configuration is effective only when using file-based sources such as Parquet, JSON and ORC.</p>
</blockquote>

<p>By using the aforementioned property and method, we can know the default number of partitions being created and then modify it to our liking. We want to control the size of the partitions because we don’t want too much data shuffled around. Because each partition is sent to an executor, the number of partitions determines how much data is shuffled around.</p>

<h3 id="output-partition">Output partition</h3>

<p>Output partition is essential whenever we are reading data for further processing. If there are several partitions, data will be spread over many files, making it more time-consuming to search for specific criteria in the first query. Whenever our job is finished and we are writing back the data, at that point, the output partition determines the number of files that will get returned to our disk. The larger the number of partitions, the larger the number of files. The total number of files generated is directly proportional to the number of output partitions.</p>

<p>Also, our memory utilization will be higher while processing the metadata table, as it contains several partitions. Having said that, the output partition influences how we write the data back into the disk after the job is completed.</p>

<h4 id="what-influences-the-output-partition">What influences the output partition?</h4>

<p>There are two methods that can influence the way our data is written:</p>

<ul>
  <li><code>repartition</code> - The repartitioning operation <em>reduces</em> or <em>increases</em> the number of partitions. This is a costly operation that involves shuffling all the data over the network and redistributing it so that it is spread out evenly. Data is serialized, transferred, and then de-serialized throughout this process.</li>
  <li><code>coalesce</code> - The coalesce operation uses existing partitions and <em>reduces</em> (doesn’t increase) the number of partitions to minimize the amount of data that’s shuffled. Coalesce results in partitions that contain different amounts of data. In most cases, the coalesce runs faster than the repartition operation.</li>
</ul>

<p>By using <code>coalesce</code> and <code>repartition</code>, we can limit the output to a certain number of files or tasks.</p>

<h3 id="shuffle-partition">Shuffle partition</h3>

<p>In cases of wide transformations, where data is required from other partitions, Spark performs a data shuffle. We can’t avoid making such wide transformations, but we can reduce the impact on performance by configuring parameters. Wide transformations use shuffle partitions to shuffle data. We can control the shuffle partition using <code>spark.sql.shuffle.partitions</code>.</p>

<blockquote>
  <p><strong>Note:</strong> The number of partitions is fixed at 200 regardless of the data’s size or the number of executors.</p>
</blockquote>

<h4 id="how-to-set-shuffle-partition">How to set shuffle partition?</h4>

<p>When the data is small, the number of partitions should be reduced; otherwise, too many partitions containing less data will be created, resulting in too many tasks with less data to process.</p>

<p>When working with a big dataset, it may be beneficial to increase the shuffle partition from the default value of 200.</p>

<h2 id="spark-partitioning-strategies">Spark partitioning strategies</h2>

<p>Apache Spark supports two types of partitioning strategies:</p>

<ul>
  <li><strong>Hash partitioning</strong> (Default)</li>
  <li><strong>Range partitioning</strong></li>
</ul>

<p>Let’s understand the rationale for the need for a variety of partitioning strategies. A suitable data partitioning strategy will enable us to reduce the skew in the data. Keep in mind that Spark limits the size of a partition to 2 GB, although there may be cases when a single key includes several relevant records that add up to more than 2 GB in total. If we have partitioned our data on that specific key, then we are going to have problems shuffling that data; we will get errors. So, picking the right partitioning strategy is very important. It also helps us get the best performance out of different operations like <code>join</code> and <code>groupby</code>.</p>

<p>Choosing the right partitioning strategy will help us to co-locate the data. The term “collate the data” refers to the fact that data that is processed together is also stored together. By doing so, we may avoid redistributing data around the cluster every time we do a <code>groupby</code> or <code>join</code> operation.</p>

<p>Partitioning decisions are influenced by a wide variety of factors, including:</p>

<ul>
  <li>Available resources (CPU, memory, and network)</li>
  <li>Transformation used to derive RDD -</li>
</ul>

<h2 id="how-do-we-get-the-right-partitions">How do we get the right partitions?</h2>

<h3 id="recommended-number-of-partitions">Recommended number of partitions</h3>
<p>Apache Spark can only run a single concurrent task for every partition of an RDD, up to the number of available cores in our cluster (and probably 2 to 3 times that). Hence, it is common practice to choose a good number of partitions equal to or more than the number of executors to maximize parallelism. For example, if we have eight worker nodes and each node has four CPU cores, we may set the number of partitions to be anywhere from 64 (2 x 8 x 4) to 96 (3 x 8 x 4).</p>

<p>By calling <code>sc.defaultParallelism</code> we can get the default level of parallelism defined on <code>SparkContext</code>. The maximum size of a partition is limited by how much memory an executor has.</p>

<h3 id="recommended-partition-size">Recommended partition size</h3>

<p>The average partition size ranges from 100 MB to 1000 MB. For instance, if we have 30 GB of data to be processed, there should be anywhere between 30 (30 gb / 1000 mb) and 300 (30 gb / 100 mb) partitions.</p>

<h3 id="other-factors-to-be-considered">Other factors to be considered</h3>

<p>It is important to understand and carefully choose the right operators for actions like <code>reduceByKey</code> or <code>aggregateByKey</code> so that our driver is not put under pressure and the tasks are properly executed on executors. </p>

<p>When data is skewed, it is recommended to use an appropriate key that can spread the load evenly. Sometimes, it may not be clear which re-partitioning key should be used to make sure data is evenly distributed. In these situations, we can use methods like <strong>salting</strong>, which involves adding a new fake or random key and using it along with the current key for better distribution of data. This is how it works: <code>saltKey = actualJoinKey + randomFakeKey</code>.</p>

<h2 id="hive-partition-vs-spark-partition">Hive partition vs. Spark partition</h2>

<p>Hive partition is not the same as Spark partition. The two are completely different. They are both subsets of the superset, but a Spark partition is a piece of data that has been broken down so that it can be processed in parallel in memory. Hive partition is in disk storage and persistence.</p>

<hr />

<h1 id="bucketing-in-spark">Bucketing in Spark</h1>

<p>Bucketing is an optimisation feature that Apache Spark (also in Apache Hive) has supported since version 2.0. It’s a way to improve performance by dividing data into smaller, manageable portions called “buckets” to identify data partitioning as it’s being written down. This feature is intended to improve the efficiency of reading same data. This efficiency improvement is mostly about getting rid of shuffles (also called exchanges) in join and aggregation queries.</p>

<blockquote>
  <p>Apache Hive popularised buckets, and Apache Spark added their support.</p>
</blockquote>

<p>Shuffle is a very expensive operation as it moves the data between executors or even across worker nodes in a cluster. Hence, it should be avoided wherever feasible. When there is a problem with the performance of Spark jobs, we should examine the transformations that involve shuffling.</p>

<p>With bucketing, we can pre-shuffle and store the data in a pre-shuffled form. It controls the physical arrangement of the data, thus we shuffle the data beforehand to prevent having to do it later on.</p>

<h2 id="sorting-the-bucket">Sorting the bucket</h2>

<p>In addition to bucketing, we can also do sorting, which sorts each bucket according to the given fields. However, the opposite is not possible; we cannot sort without bucketing.</p>

<h2 id="configure-bucketing">Configure bucketing</h2>

<p>Note that bucketing is enabled by default. Spark controls whether or not it should be enabled using the configuration property <code>spark.sql.sources.bucketing.enabled</code>.</p>

<h2 id="how-to-create-buckets">How to create buckets?</h2>

<p>In Spark API, the bucketBy method can be used for this purpose.</p>

<pre><code class="language-python">bucketBy(n, field1, field2, ...)
</code></pre>

<p>The first argument specifies the number of buckets to generate. The number of buckets is equal to the number of files generated.</p>

<pre><code class="language-python"># In Python
df.write\
    .bucketBy(16, "key")\
    .sortBy("value")\
    .saveAsTable("table_name")
</code></pre>

<h2 id="bucketing-applicable-only-to-persistent-tables">Bucketing applicable only to persistent tables</h2>

<p>Only persistent tables can be used for bucketing and sorting. We can only use the <code>saveAsTable</code> method; we can’t use the <code>save</code> method.</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments mt-5">
    <button class="btn btn-outline-dark py-3 px-5 d-block w-100 show-comments"><i class="fa fa-comments text-muted"></i> &nbsp; Show comments</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'rustinaction'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <!-- <ul>
        <li class="ml-1 mr-1">
            <a href="/" ><i class="fas fa-home"></i></a>
        </li>
    </ul>
    <hr> -->
    <!---->
    <span>Share</span>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Partitions and Bucketing in Spark&url=http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa-brands fa-x-twitter"></i>
            </a>
        </li>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>
        <!--<li class="ml-1 mr-1">
            <a target="_blank" href="http://news.ycombinator.com/submitlink?u=http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-y-combinator"></i>
            </a>
        </li>
        <li class="ml-1 mr-1">
            <a target="_blank" href="http://www.reddit.com/submit?url=http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions&title=Partitions and Bucketing in Spark" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-reddit"></i>
            </a>
        </li>-->                 
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://api.whatsapp.com/send?text=Partitions and Bucketing in Spark%20http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-whatsapp"></i>
            </a>
        </li>
        <li class="ml-1 mr-1">
            <a href="#" onclick="copyToClipboard()">
                <i class="fas fa-link"></i>
            </a>
            <script>
                function copyToClipboard() { 
                   window.navigator.clipboard.writeText(`http://localhost:4000/apache-spark/2022/spark-bucketing-and-partitions`);
                }
            </script>
        </li>         
        <!--
        
            <ul>
                <li>
                <a class="small" href="#disqus_thread"></a>
                </li>
            </ul>
           
        -->
    </ul>
    <!---->
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Explore more like this</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">
    
    <!-- Categories -->
    <!--
    
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#apache-spark">apache-spark</a>                
    
    -->

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary text-lowercase" href="/tags#apache-spark">apache-spark</a>               
                    
    <a class="smoothscroll badge badge-primary text-lowercase" href="/tags#bucketing">bucketing</a>               
                    
    <a class="smoothscroll badge badge-primary text-lowercase" href="/tags#partition">partition</a>               
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
                <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/apache-spark/2022/spark-caching-data-in-memory">
                
                    
                        <img class="img-thumb" src="/assets/images/posts-cover-images/spark-caching-data-in-memory.jpg" alt="Need for Caching in Apache Spark"> 
                    
                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/apache-spark/2022/spark-caching-data-in-memory">Need for Caching in Apache Spark</a>
                
            </h2>
            <span class="card-text"></span>
        </div>
        <!-- 
            <div class="card-footer d-flex align-items-center mt-0" style="font-size: 85%">
                <div>
                    <img class="author-thumb" src="https://www.gravatar.com/avatar/6fc127cda8cd99830932538a58dc6173?s=250&d=mm&r=x" alt="Senthil Nayagan">
                </div>
                <div class="post-name">
                    <span class="author-name">
                        <b>Senthil Nayagan</b>
                    </span>
                    <br/>
                    <span style="color: rgba(23, 24, 30, .5);"><i class="fa-regular fa-calendar-days"></i>&nbsp;Jul 24, 2022 - <i class="fa-solid fa-clock"></i><span class="reading-time">
  
  
    2 Mins Read
  
</span></span>
                </div>
            </div>
         -->
        <div class="clearfix"></div>

        <!-- Tags -->
        <div class="card-footer">
            <ul class="tags">
                
                
                <li>
                    <a class="smoothscroll" href="/tags#apache-spark">apache-spark</a>
                </li>
                
                <li>
                    <a class="smoothscroll" href="/tags#cache">cache</a>
                </li>
                
                <li>
                    <a class="smoothscroll" href="/tags#data-caching">data-caching</a>
                </li>
                
            </ul>                    
        </div>        
    </div>
</div>
<!-- end post -->
                
                
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
            
                
                
            
                
            
                
               
        
               
        
            
                
                
            
                
            
                
               
        
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

        </div>

        
        <!-- Newsletter -->
        <div class="newsletter text-center">
            <span class="h4"><!--<img src="/assets/images/logo/logo_transparent.png" class="newsletter-logo" alt="thoughtful works"> &nbsp;-->If you like our posts and don't want to miss any of them, sign up for our newsletter.</span>
            <form action="https://gmail.us17.list-manage.com/subscribe?u=155954fdd35cc37fcbfab134a&id=acc42a78d4" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
                <div class="mc-field-group d-inline-flex">
                <input type="email" placeholder="Your e-mail" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
                <input type="submit" value="Subscribe" name="subscribe" class="heart">
                </div>
            </form>
        </div>
        
        
    </div>

    <!-- Begin Footer -->
    <!-- <script>
        const repoOwner = 'rust-lang';
        const repoName = 'rust';

        const apiUrlRelease = `https://api.github.com/repos/${repoOwner}/${repoName}/releases/latest`;
      
        fetch(apiUrlRelease)
            .then(response => response.json())
            .then(data => {
            document.getElementById('current-release').innerText = `${data.tag_name}`;
            document.getElementById('release-url').innerHTML = `<a href="${data.html_url}" target="_blank">${data.tag_name}</a>`;
            })
            .catch(error => console.error('Error fetching GitHub release information:', error));
    </script>  -->

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-sm-12 text-center text-lg-left">
                    Copyright © 2024 <b>thoughtful works</b> | <a href="/privacy-policy.html" target="_blank">Privacy Policy</a> | Made with <b>Jekyll</b> and hosted on <b>GitHub Pages</b> | This website DOES NOT use cookies.
                </div>
                <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                    <!-- <i class="fa-brands fa-rust"></i> <a href=`<span id="release-url"></span>`><span id="current-release"></span></a>&nbsp;<i class="fa-solid fa-tag"></i>&nbsp;(latest) -->
                    <!-- - <i class="fa-solid fa-star"></i> <span id="repo-stars"></span> -->
                </div>
            </div>
        </div>
    </footer>
    <!-- End Footer -->

    </div> <!-- /.site-content -->

    <!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme) -->

    <script src="/assets/js/prism.js"></script>

    <script src="/assets/js/theme.js"></script>

    

    
    <script id="dsq-count-scr" src="//rustinaction.disqus.com/count.js"></script>
    
</body>
</html>
